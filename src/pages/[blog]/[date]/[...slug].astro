---
import type { CollectionEntry } from "astro:content";
import { getCollection, getEntry, render } from "astro:content";
import slugify from "@sindresorhus/slugify";
import ArticleLayout from "@root/layouts/article.astro";
import { createRelativeArticleUrl, removeLanguageCodeFromPath } from "@root/utils";
import directus from "@/directus";
import type { ArticleTranslation } from "@/directus-schema";

/**
 * Generate articles pages from `blog` collection.
 * The final url will be `http://website.com/blog/2023-01-01/my-article` with default language
 * and `http://website.com/{language-code}/blog/2023-01-01/my-article` with other languages.
 */
// export async function getStaticPaths() {
// 	const collection = await getCollection("blog", (e) => !e.data.draft);
// 	return collection.map((article) => {
// 		const {
// 			id,
// 			data: { title, pubDate },
// 		} = article;
// 		const url = createRelativeArticleUrl({ id, title, pubDate });
// 		return {
// 			params: { blog: url.slice(1) },
// 			props: {
// 				article,
// 				availableOnLangs: collection.filter((e) =>
// 					e.id.includes(removeLanguageCodeFromPath(article.id))
// 				),
// 			},
// 		};
// 	});
// }

type Props = { article: CollectionEntry<"blog">; availableOnLangs: CollectionEntry<"blog">[] };

const { slug } = Astro.params as { blog: string; date: string; slug: string };

const { article_translations: data } = await directus.query<{
	article_translations: ArticleTranslation[];
}>(`
  query Article_translations {
      article_translations(
          filter: {
              slug: {
                  _eq: "${slug}"
              }
          }
      ) {
          title
          tags {
              tag_id {
                  title
              }
          }
          description
          slug
          content
          author {
              first_name
              last_name
          }
          pub_date
          views
          languages_code {
            code
          }
          cover_image {
              title
              filename_disk
          }
      }
  }
`);

// const { blog } = Astro.params as { blog: string };
// const collection = await getCollection("blog", (e) => !e.data.draft);
// const slug = blog.split("/").at(-1);
// const article = collection.find(
// 	(a) => slugify(a.slug.split("/").at(-1) || "", { lowercase: true }) === slug
// );

if (data.length === 0) return Astro.redirect("/404");

const article = data[0];

// const { Content, headings } = await render(article);
// const { article, availableOnLangs } = Astro.props;
---

<ArticleLayout lang={article.languages_code.code} article={article} />
